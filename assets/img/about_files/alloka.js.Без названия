function geoInit(){"undefined"!=typeof _alloka&&_alloka.use_geo&&loadYandexGeo()}function getProtocol(){return"undefined"!=typeof _alloka?("undefined"==typeof _alloka.server_host&&(_alloka.server_host=allokaDevelopment?"127.0.0.1:3000":"analytics.alloka.ru"),"analytics.alloka.ru"==_alloka.server_host?"https://":"http://"):"https://"}function loadModal(){var t=getProtocol(),e=document.createElement("link");if(e.rel="stylesheet",e.type="text/css","undefined"==typeof _alloka||"undefined"==typeof _alloka.server_host)var i="analytics.alloka.ru";else var i=_alloka.server_host;e.href=t+i+"/assets/modal.css",document.getElementsByTagName("head")[0].appendChild(e)}function loadYandexGeo(){var t=document.createElement("script"),e=document.getElementsByTagName("head")[0];t.setAttribute("type","text/javascript"),t.setAttribute("src","//api-maps.yandex.ru/2.1/?lang=ru_RU"),e.appendChild(t),t.onload=function(){ymaps.ready({successCallback:function(){geoSubstitute()}})}}function geoSubstitute(){ymaps.geolocation.get().then(function(t){_alloka.coordinates=t.geoObjects.position,allokaSubstitute()})}function leaveFeedback(t){var e=new XMLHttpRequest,i=getProtocol();e.open("POST",i+_alloka.server_host+"/api/site/feedback/",!0),e.setRequestHeader("Content-type","application/json"),t=JSON.stringify(t),e.send(t)}function allokaInit(){try{if("undefined"!=typeof _alloka){if("undefined"!=typeof _alloka.event_binded)return void allokaDebug("allokaInit: event binded: exiting...");_alloka.event_binded=!0,"undefined"==typeof _alloka.auto_substitute&&(_alloka.auto_substitute=!0),_alloka.auto_substitute&&allokaSubstitute()}else allokaLanding()}catch(t){allokaLog(t)}}function allokaModal(t){Modal.open({content:t,width:"60%"})}function allokaSubscribe(t){if("undefined"!=typeof Faye){console.log(t.session_id);var e=getProtocol(),i=new Faye.Client(e+_alloka.server_host+":9292/faye");try{i.unsubscribe("/client_notifications/"+t.session_id),i.unsubscribe("/client_notifications_js/"+t.session_id)}catch(n){allokaLog(n)}t.feedback_popup_enabled&&i.subscribe("/client_notifications/"+t.session_id,function(t){allokaModal(t)}),t.feedback_js_enabled&&i.subscribe("/client_notifications_js/"+t.session_id,function(t){var e=window[t.name];"function"==typeof e&&e(t.params)})}else console.log("Faye is undefined")}function allokaSubstitute(){try{var t,e,i,n,o="aa_v4_";if("undefined"==typeof _alloka)return!1;allokaAddEvent(window,"load",allokaSendGaClientId),"undefined"==typeof _alloka.server_host&&(_alloka.server_host="analytics.alloka.ru"),"undefined"==typeof _alloka.last_source&&(_alloka.last_source=!1),_alloka.is_mobile=allokaIsMobile(),_alloka.cookie_prefix=o,allokaIsArray(_alloka.trackable_source_types)||(_alloka.trackable_source_types=["typein","type_in","referrer","utm"]);for(var r in _alloka.objects){var s,a,l,c,u;if(s=_alloka.objects[r],s.oid=r,n=_alloka.cookie_prefix+r,"undefined"==typeof s.format&&(s.format="+7 (#{XXX}) #{XXX}-#{XX}-#{XX}"),"undefined"==typeof s.block_class&&(s.block_class="phone_alloka"),"undefined"==typeof s.is_fixed_number&&(s.is_fixed_number=!1),0!=allokaGetElementsByClassName(s.block_class).length){if(allokaSetValueToBlocksByClass(s.block_class,"",s),(t=allokaGetCookie(_alloka.cookie_prefix+"number_"+r))&&""!=typeof t?(s.cached_number=t,allokaSetValueToBlocksByClass(s.block_class,s.cached_number,s)):"undefined"!=typeof s.default_number&&allokaSetValueToBlocksByClass(s.block_class,s.default_number,s),t=allokaGetCookie(n))try{t=JSON.parse(Base64.decode(t)),allokaIsArray(t)&&t.length>=3&&"undefined"!=typeof t[0]&&allokaIsString(t[0])&&32==t[0].length?(s.session_id=t[0].length?t[0]:allokaGenerateSessionId(),e="undefined"!=typeof t[1]&&allokaIsString(t[1])&&t[1].length>0&&allokaReferrerIsValid(t[1])?t[1]:void 0,i="undefined"!=typeof t[2]&&allokaIsString(t[2])&&t[2].length>0?t[2]:void 0):t=void 0}catch(h){t=void 0}if(1==_alloka.last_source||"undefined"==typeof t){(1!=_alloka.last_source||"undefined"==typeof t)&&(s.session_id=allokaGenerateSessionId());var d=allokaGetUrlParameters(document.location.search.substr(1),["alloka_referrer","alloka_search"]);"undefined"!=typeof d&&allokaIsObject(d)&&d.alloka_referrer?e=unescape(d.alloka_referrer):document.referrer.length>0&&allokaReferrerIsValid(document.referrer)?e=document.referrer:(1!=_alloka.last_source||"undefined"==typeof t)&&(e=void 0),"undefined"!=typeof d&&allokaIsObject(d)&&d.alloka_search?i=unescape(d.alloka_search):document.location.search&&document.location.search.length>0?i=document.location.search.substr(1):(1!=_alloka.last_source||"undefined"==typeof t)&&(i=void 0),t=Base64.encode(JSON.stringify([s.session_id,e,i])),allokaSetCookie(n,t,1)}allokaIsArray(s.trackable_source_types)?(l=s.trackable_source_types.indexOf("typein")>-1||s.trackable_source_types.indexOf("type_in")>-1,c=s.trackable_source_types.indexOf("referrer")>-1,u=s.trackable_source_types.indexOf("utm")>-1):(l=_alloka.trackable_source_types.indexOf("typein")>-1||_alloka.trackable_source_types.indexOf("type_in")>-1,c=_alloka.trackable_source_types.indexOf("referrer")>-1,u=_alloka.trackable_source_types.indexOf("utm")>-1);var p=!1,f=!1;if(p=e&&e.length>0,i&&i.length>0){var m=allokaGetUrlParameters(i);if(allokaGetObjectSize(m))for(var g in m)if(g.indexOf("utm_")>-1){f=!0;break}}l||(p||f)&&(p||!c||u)&&(f||!u||c)?"undefined"!=typeof _alloka.url_params&&!allokaCheckParams(i,_alloka.url_params)||"undefined"!=typeof s.url_params&&!allokaCheckParams(i,s.url_params)||"undefined"!=typeof _alloka.deny_on_url_params&&allokaCheckParams(i,_alloka.deny_on_url_params)||"undefined"!=typeof s.deny_on_url_params&&allokaCheckParams(i,s.deny_on_url_params)?allokaSetValueToBlocksByClass(s.block_class,void 0,s):"undefined"!=typeof _alloka.referrer_domains&&(!p||!allokaCheckDomain(e,_alloka.referrer_domains))||"undefined"!=typeof s.referrer_domains&&(!p||!allokaCheckDomain(e,s.referrer_domains))||p&&"undefined"!=typeof _alloka.deny_on_referrer_domains&&allokaCheckDomain(e,_alloka.deny_on_referrer_domains)||p&&"undefined"!=typeof s.deny_on_referrer_domains&&allokaCheckDomain(e,s.deny_on_referrer_domains)?allokaSetValueToBlocksByClass(s.block_class,void 0,s):(a={oid:r,session_id:s.session_id},_alloka.custom_data&&"object"==typeof _alloka.custom_data&&(a.custom_data=_alloka.custom_data),_alloka.url_parameters&&"object"==typeof _alloka.url_parameters&&(a.url_parameters=allokaGetUrlParameters(document.location.search.substr(1),_alloka.url_parameters),"object"!=typeof a.url_parameters&&delete a.url_parameters),e&&e.length>0&&(a.referrer=e),i&&i.length>0&&(a.search=i),"undefined"==typeof _alloka.coordinates&&(_alloka.coordinates=!1),_alloka.coordinates&&_alloka.coordinates.length>0&&(a.coordinates=_alloka.coordinates),a.city=_alloka.city,allokaMakeRequest("/api/site/retrieve_number",a,allokaHandleResponse)):allokaSetValueToBlocksByClass(s.block_class,void 0,s)}else allokaDebug("allokaSubstitute: no elements: continue..")}}catch(h){allokaLog(h)}}function allokaSendGaClientIdObj(t,e){allokaDebug("allokaSendGaClientIdObj "+t);var i,n=_alloka.objects[t];return"undefined"==typeof n.success||0==n.success||"undefined"==typeof n.session_id?void allokaDebug("Internal error"):"undefined"!=typeof n.is_fixed_number&&1==n.is_fixed_number?void allokaDebug("Not for fixed number"):(i={oid:n.oid,session_id:n.session_id,ga_client_id:e},void allokaMakeRequest("/api/site/set_ga_client_id",i,allokaHandleGaResponse))}function allokaSendGaClientIdObjDefer(t,e){allokaDefer(t,function(){allokaSendGaClientIdObj(t,e)})}function allokaSendGaClientId(){allokaDebug("allokaSendGaClientId");try{if("object"!=typeof _alloka)return;var t;t="undefined"!=typeof ga?ga:function(t){t()},t(function(){var t;if("undefined"!=typeof ga&&(t=ga.getAll()[0].get("clientId")),t||(console.log("get_ga_client_id fallback."),t=allokaGetGoogleClientId()),allokaDevelopment&&(t="test"),t)for(var e in _alloka.objects)allokaSendGaClientIdObjDefer(e,t)})}catch(e){allokaLog(e)}}function allokaDeferPush(t,e){"object"!=typeof _alloka_defer[t]&&(_alloka_defer[t]=[]),_alloka_defer[t].push(e)}function allokaDefer(t,e){_alloka.objects[t].success?(e(),allokaDeferPush(t,e)):allokaDeferPush(t,e)}function allokaExecute(t){if(_alloka_defer[t])for(var e in _alloka_defer[t])_alloka_defer[t][e]()}function allokaSendCustomDataDefer(t,e){allokaDefer(t,function(){allokaSendCustomDataOrig(t,e)})}function allokaSendCustomDataOrig(t,e){allokaDebug("allokaSendCustomDataOrig "+t);try{if("object"!=typeof _alloka||!allokaIsString(t))return;var i,n,o=_alloka.objects[t];if("undefined"==typeof o.session_id)return void allokaLog("'Can't send custom_data: number has not substituted");"undefined"!=typeof e?i=e:_alloka.custom_data&&"object"==typeof _alloka.custom_data&&(i=_alloka.custom_data),n={oid:o.oid,session_id:o.session_id,custom_data:i},"undefined"!=typeof i&&allokaMakeRequest("/api/site/set_custom_data",n,allokaHandleCsResponse)}catch(r){allokaLog(r)}}function allokaHandleCsResponse(t,e,i){try{var n,o;if(o=_alloka.objects[i],200==e||422==e)if(allokaIsObject(t))n=t;else{if(!allokaIsString(t)||!allokaJsonAvailable())throw"unable_to_parse_response";n=JSON.parse(t)}}catch(r){allokaLog(r)}}function allokaHandleGaResponse(t,e,i){try{var n,o;if(o=_alloka.objects[i],200==e||422==e)if(allokaIsObject(t))n=t;else{if(!allokaIsString(t)||!allokaJsonAvailable())throw"unable_to_parse_response";n=JSON.parse(t)}}catch(r){allokaLog(r)}}function allokaLanding(){try{var t,e,i,n,o="aa_v4_",r="alloka_link",s=document.getElementsByClassName(r);if(s.length){if(n=o+"landing",t=allokaGetCookie(n))try{t=JSON.parse(Base64.decode(t)),allokaIsArray(t)&&t.length>=2?(e="undefined"!=typeof t[0]&&allokaIsString(t[0])&&t[0].length>0&&allokaReferrerIsValid(t[0])?t[0]:void 0,i="undefined"!=typeof t[1]&&allokaIsString(t[1])&&t[1].length>0?t[1]:void 0):t=void 0}catch(a){t=void 0}if("undefined"==typeof t&&(e=document.referrer.length>0&&allokaReferrerIsValid(document.referrer)?document.referrer:void 0,i=document.location.search&&document.location.search.length?document.location.search.substr(1):void 0,t=Base64.encode(JSON.stringify([e,i])),allokaSetCookie(n,t,1)),i&&i.length&&(i="alloka_search="+escape(i)),e&&e.length&&(i=(i&&i.length?i+"&":"")+"alloka_referrer="+escape(e)),i&&i.length)for(block in s)if("object"==typeof s[block]){var l,c,u,h,d;l=s[block],c=l.getAttribute("href"),d=l.getAttribute("onclick"),u=c&&c.length?c+(-1==c.indexOf("?")?"?":"&")+i:"?"+i,h="this.setAttribute('href', '"+u+"')",d&&d.length?(d=d.replace(c,u),l.setAttribute("onclick",h+"; "+d)):l.setAttribute("onclick",h)}}}catch(a){allokaLog(a)}}function allokaGetUrlParameters(t,e){var i,n={};if(t&&allokaIsString(t)&&t.length>0){i=t.split("&");for(var o=0;o<i.length;o++){var r=i[o].split("=");n[r[0]]=r[1]}}if("object"==typeof e){var s={};for(var o in n)e.indexOf(o)>=0&&(s[o]=n[o]);n=s}var a=0;for(var o in n)a++;return 0==a?void 0:n}function allokaCheckParams(t,e){if(allokaIsArray(e)){var i=allokaGetUrlParameters(t,e);return allokaGetObjectSize(i)==allokaGetObjectSize(e)}if(allokaIsObject(e)){var n=allokaGetObjectKeys(e),i=allokaGetUrlParameters(t,n);if(allokaIsObject(i)&&allokaGetObjectSize(i)==allokaGetObjectSize(e)){for(var o in e){if(allokaIsArray(e[o])){for(var r in e[o])if("undefined"!=typeof e[o][r]&&"undefined"!=typeof i[o]&&e[o][r].toString()==i[o].toString())return!0;return!1}if("undefined"==typeof e[o]||"undefined"==typeof i[o]||e[o].toString()!=i[o].toString())return!1}return!0}return!1}return!1}function allokaGetDomainFromUrl(t){var e,i=t.match(/^(http|https)?\:\/\/([^\/?#]+)?(?:[\/?#]|$)/i);return allokaIsArray(i)&&i[2].length>0?(e=i[2],-1!=e.indexOf(":")&&(e=e.split(":").shift()),0==e.indexOf("www.")&&(e=e.substr(4)),e):null}function allokaCheckDomain(t,e){var i=allokaGetDomainFromUrl(t);if(allokaIsArray(e)){for(var n in e)if(allokaSameDomain(i,e[n]))return!0}else if(allokaIsString(e))return allokaSameDomain(i,e);return!1}function allokaSameDomain(t,e){return t==e||"www."+t==e||t=="www."+e}function allokaSetCookie(t,e,i){if(void 0===i)document.cookie=t+"="+escape(e)+"; path=/;";else{var n=new Date;n.setDate(n.getDate()+i),document.cookie=t+"="+escape(e)+";expires="+n+"; path=/;"}}function allokaGetCookie(t){var e,i,n,o=document.cookie.split(";");for(e=0;e<o.length;e++)if(i=o[e].substr(0,o[e].indexOf("=")),n=o[e].substr(o[e].indexOf("=")+1),i=i.replace(/^\s+|\s+$/g,""),i==t)return unescape(n);return void 0}function allokaMakeRequest(t,e,i,n){if(!allokaJsonAvailable())throw"unsupported_browser";var o,r,s;if(n=n?n:1e4,"object"!=typeof e&&(e={}),e.oid&&(o=_alloka.objects[e.oid]),e.location=document.location.toString(),1==allokaDetectCORS()){if(e=JSON.stringify(e),"string"!=typeof e||e.length<=0)throw"json_stringify_failure";var a=getProtocol();r=a+_alloka.server_host+t;for(var l=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],c=0;c<l.length;c++){try{s=l[c]()}catch(u){continue}break}if(!s)return;s.open("POST",r,!0),s.timeout=n,s.setRequestHeader("Content-Type","application/json"),s.setRequestHeader("Accept","application/json"),s.onreadystatechange=function(){4==s.readyState&&i&&"function"==typeof i&&i(s.responseText,s.status,o.oid)},s.onerror=function(){allokaLog("request failed to "+r),"undefined"==typeof e.ga_client_id&&(o.failure=!0,allokaSetValueToBlocksByClass(o.block_class,void 0,o))},s.ontimeout=function(){allokaLog("request timeout to "+r),"undefined"==typeof e.ga_client_id&&(o.failure=!0,allokaSetValueToBlocksByClass(o.block_class,void 0,o))},s.send(e)}else{r="http://"+_alloka.server_host+t+"?callback="+i.toString().match(/^function\s*([^\s(]+)/)[1],r+="&data="+Base64.encode(JSON.stringify(e));var h=document.createElement("script");h.type="text/javascript",h.src=r,document.getElementsByTagName("head")[0].appendChild(h)}}function allokaHandleResponse(t,e,i){try{var n,o,r;if(r=_alloka.objects[i],200==e||422==e)if(allokaIsObject(t))o=t;else{if(!allokaIsString(t)||!allokaJsonAvailable())throw"unable_to_parse_response";o=JSON.parse(t)}else if(200!=e)return void allokaSetValueToBlocksByClass(r.block_class,void 0,r);if(void 0===o.data||"object"!=typeof o.data||"object"==typeof o.errors){"string"==typeof o.errors&&(o.errors=[[o.errors]]);for(var s in o.errors)allokaLog(o.errors[s].join(", "),r)}if("object"==typeof o.data&&allokaIsString(o.data.number)&&o.data.number.length>=6&&"object"!=typeof o.errors){if(r.success=!0,r.is_fixed_number="undefined"!=typeof o.data.is_fixed_number,"undefined"!=typeof o.data.feedback_popup_enabled&&o.data.feedback_popup_enabled===!0&&(r.feedback_popup_enabled=!0),"undefined"!=typeof o.data.feedback_js_enabled&&o.data.feedback_js_enabled===!0&&(r.feedback_js_enabled=!0),(r.feedback_popup_enabled||r.feedback_js_enabled)&&allokaSubscribe(r),allokaDebug("done "+r.oid),allokaExecute(r.oid),n=o.data.number.substr(1),void 0!==r.cached_number&&n==r.cached_number)return;allokaSetCookie(_alloka.cookie_prefix+"number_"+r.oid,n)}else n=void 0;allokaSetValueToBlocksByClass(r.block_class,n,r)}catch(a){allokaLog(a)}}function allokaSetValueToBlocksByClass(t,e,i){var n=allokaGetElementsByClassName(t);if("object"==typeof t){for(var o=0;o<t.length;o++)n=n.concat(Array.prototype.slice.call(document.getElementsByClassName(t[o])));n=allokaArrayUnique(n)}else n=document.getElementsByClassName(t);for(var o=0;o<n.length;o++)if(""===e)n[o].setAttribute("data-phone",escape(n[o].innerHTML));else if(void 0===e)void 0!=n[o].getAttribute("data-phone")&&allokaGetCookie(_alloka.cookie_prefix+"number_"+i.oid)&&allokaSetCookie(_alloka.cookie_prefix+"number_"+i.oid,"",-1);else{if(window.allokaFormatPhoneHook)var r=window.allokaFormatPhoneHook(n[o],e);else var r=allokaFormatPhone(e,i.format);if(_alloka.is_mobile){for(var s="",a=0;a<n[o].attributes.length;a++)"href"!=n[o].attributes[a].name&&(s+=n[o].attributes[a].name+'="'+n[o].attributes[a].value+'" ');n[o].outerHTML="<a "+s.trim()+' href="tel:+'+r.replace(/\D/g,"")+'" style="cursor: default; text-decoration: none; cursor: default;">'+r+"</a>"}else n[o].innerHTML=r}}function allokaGenerateSessionId(){var t=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return t()+t()+t()+t()+t()+t()+t()+t()}function allokaFormatPhone(t,e){for(var i="",n=e.match(/#{(X)+}/gi),o=e,r=0;r<n.length;r++)o=o.replace(/#{(X)+}/i,"$$"+(r+1)),i+="("+n[r].slice(2,-1).replace(/(X)/gi,"\\d")+")";return i=new RegExp(i),t.replace(i,o)}function allokaBindReady(t){function e(){return n?n=!0:void t()}function i(){if(n)return!1;try{document.documentElement.doScroll("left"),e()}catch(t){setTimeout(i,10)}}var n=!1;if(document.addEventListener)document.addEventListener("DOMContentLoaded",e,!1);else if(document.attachEvent){try{var o=null!=window.frameElement}catch(r){}document.documentElement.doScroll&&!o&&i(),document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&e()})}else if(window.addEventListener)window.addEventListener("load",e,!1);else if(window.attachEvent)window.attachEvent("onload",e);else{var s=window.onload;window.onload=function(){s&&s(),e()}}}function allokaGetElementsByClassName(t){var e=[];if("object"==typeof t){for(var i=0;i<t.length;i++)e=e.concat(Array.prototype.slice.call(document.getElementsByClassName(t[i])));e=allokaArrayUnique(e)}else e=document.getElementsByClassName(t);return e}function allokaGetGoogleClientId(){var t,e=allokaGetCookie("_ga");if("undefined"!=typeof e&&e.length>0)return t=e.split(".").slice(2,4).join("."),t.length>0?t:null;var i=allokaGetCookie("__utma");return"undefined"!=typeof i&&i.length>0?(t=i.split(".").slice(1,3).join("."),t.length>0?t:null):null}function allokaIsMobile(){return null!=navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|Symbian|Nokia|IEMobile|MeeGo|Maemo/i)}function allokaReferrerIsValid(t){var e=t.split("://");return e.shift(),t&&t.length>0&&0!=e[0].toString().indexOf(document.location.host)}function allokaLog(t,e){if("undefined"!=typeof t){var i;i="undefined"!=typeof t.stack&&t.stack.length>0?[t.message].concat(t.stack):"undefined"!=typeof t.message&&t.message.length>0?t.message:t,-1==["invalid_oid","order_not_found","inactive_order","inactive_object","ip_address_blocked","unable_to_retrieve_a_number"].indexOf(i)&&allokaRemoteErrorLog(i,e),i="Alloka error: "+i,"undefined"!=typeof console?console.log(i):"undefined"!=typeof window.console&&window.console.log(i)}}function allokaIsDebug(){return allokaDevelopment||"undefined"!=typeof _alloka&&_alloka.debug}function allokaDebug(t){allokaIsDebug()&&console.log(t)}function allokaRemoteErrorLog(t,e){var i="http://"+_alloka.server_host+"/api/site/error_log";i+="?msg="+t,"object"==typeof e&&(i+="&oid="+e.oid),i+="&location="+Base64.encode(document.location.toString());var n=document.createElement("img");n.src=i}function allokaDetectCORS(){return"undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest?1:window.XDomainRequest?2:0}function allokaAddEvent(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent&&t.attachEvent("on"+e,i)}function allokaRemoveEvent(t,e,i){t.removeEventListener?t.removeEventListener(e,i,!1):t.detachEvent&&t.detachEvent("on"+e,i)}function allokaIsArray(t){return"undefined"!=typeof t&&"[object Array]"===Object.prototype.toString.call(t)}function allokaIsObject(t){return"undefined"!=typeof t&&"[object Object]"===Object.prototype.toString.call(t)}function allokaIsString(t){return"undefined"!=typeof t&&"[object String]"===Object.prototype.toString.call(t)}function allokaArrayUnique(t){if(allokaIsArray(t)){for(var e=t.concat(),i=0;i<e.length;++i)for(var n=i+1;n<e.length;++n)e[i]===e[n]&&e.splice(n--,1);return e}return!1}function allokaGetObjectSize(t){if(allokaIsObject(t)||allokaIsArray(t)){var e=0;for(key in t)t.hasOwnProperty(key)&&e++;return e}return 0/0}function allokaGetObjectKeys(t){if(allokaIsObject(t)){var e=[];for(var i in t)e.push(i);return e}return void 0}function allokaJsonAvailable(){return"object"==typeof JSON&&"function"==typeof JSON.stringify&&"function"==typeof JSON.parse}!function(){!function(){"use strict";var Faye={VERSION:"1.1.1",BAYEUX_VERSION:"1.0",ID_LENGTH:160,JSONP_CALLBACK:"jsonpcallback",CONNECTION_TYPES:["long-polling","cross-origin-long-polling","callback-polling","websocket","eventsource","in-process"],MANDATORY_CONNECTION_TYPES:["long-polling","callback-polling","in-process"],ENV:"undefined"!=typeof window?window:global,extend:function(t,e,i){if(!e)return t;for(var n in e)e.hasOwnProperty(n)&&(t.hasOwnProperty(n)&&i===!1||t[n]!==e[n]&&(t[n]=e[n]));return t},random:function(t){t=t||this.ID_LENGTH;for(var e=Math.ceil(t*Math.log(2)/Math.log(36)),i=csprng(t,36);i.length<e;)i="0"+i;return i},validateOptions:function(t,e){for(var i in t)if(this.indexOf(e,i)<0)throw Error("Unrecognized option: "+i)},clientIdFromMessages:function(t){var e=this.filter([].concat(t),function(t){return"/meta/connect"===t.channel});return e[0]&&e[0].clientId},copyObject:function(t){var e,i,n;if(t instanceof Array){for(e=[],i=t.length;i--;)e[i]=Faye.copyObject(t[i]);return e}if("object"==typeof t){e=null===t?null:{};for(n in t)e[n]=Faye.copyObject(t[n]);return e}return t},commonElement:function(t,e){for(var i=0,n=t.length;n>i;i++)if(-1!==this.indexOf(e,t[i]))return t[i];return null},indexOf:function(t,e){if(t.indexOf)return t.indexOf(e);for(var i=0,n=t.length;n>i;i++)if(t[i]===e)return i;return-1},map:function(t,e,i){if(t.map)return t.map(e,i);var n=[];if(t instanceof Array)for(var o=0,r=t.length;r>o;o++)n.push(e.call(i||null,t[o],o));else for(var s in t)t.hasOwnProperty(s)&&n.push(e.call(i||null,s,t[s]));return n},filter:function(t,e,i){if(t.filter)return t.filter(e,i);for(var n=[],o=0,r=t.length;r>o;o++)e.call(i||null,t[o],o)&&n.push(t[o]);return n},asyncEach:function(t,e,i,n){var o=t.length,r=-1,s=0,a=!1,l=function(){return s-=1,r+=1,r===o?i&&i.call(n):void e(t[r],u)},c=function(){if(!a){for(a=!0;s>0;)l();a=!1}},u=function(){s+=1,c()};u()},toJSON:function(t){return this.stringify?this.stringify(t,function(t,e){return this[t]instanceof Array?this[t]:e}):JSON.stringify(t)}};"undefined"!=typeof module?module.exports=Faye:"undefined"!=typeof window&&(window.Faye=Faye),Faye.Class=function(t,e){"function"!=typeof t&&(e=t,t=Object);var i=function(){return this.initialize?this.initialize.apply(this,arguments)||this:this},n=function(){};return n.prototype=t.prototype,i.prototype=new n,Faye.extend(i.prototype,e),i},function(){function t(t,e){if(t.indexOf)return t.indexOf(e);for(var i=0;i<t.length;i++)if(e===t[i])return i;return-1}var e=Faye.EventEmitter=function(){},i="function"==typeof Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};e.prototype.emit=function(t){if("error"===t&&(!this._events||!this._events.error||i(this._events.error)&&!this._events.error.length))throw arguments[1]instanceof Error?arguments[1]:Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var e=this._events[t];if(!e)return!1;if("function"==typeof e){switch(arguments.length){case 1:e.call(this);break;case 2:e.call(this,arguments[1]);break;case 3:e.call(this,arguments[1],arguments[2]);break;default:var n=Array.prototype.slice.call(arguments,1);e.apply(this,n)}return!0}if(i(e)){for(var n=Array.prototype.slice.call(arguments,1),o=e.slice(),r=0,s=o.length;s>r;r++)o[r].apply(this,n);return!0}return!1},e.prototype.addListener=function(t,e){if("function"!=typeof e)throw Error("addListener only takes instances of Function");return this._events||(this._events={}),this.emit("newListener",t,e),this._events[t]?i(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(t,e){var i=this;return i.on(t,function n(){i.removeListener(t,n),e.apply(this,arguments)}),this},e.prototype.removeListener=function(e,n){if("function"!=typeof n)throw Error("removeListener only takes instances of Function");if(!this._events||!this._events[e])return this;var o=this._events[e];if(i(o)){var r=t(o,n);if(0>r)return this;o.splice(r,1),0==o.length&&delete this._events[e]}else this._events[e]===n&&delete this._events[e];return this},e.prototype.removeAllListeners=function(t){return 0===arguments.length?(this._events={},this):(t&&this._events&&this._events[t]&&(this._events[t]=null),this)},e.prototype.listeners=function(t){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),i(this._events[t])||(this._events[t]=[this._events[t]]),this._events[t]}}(),Faye.Namespace=Faye.Class({initialize:function(){this._used={}},exists:function(t){return this._used.hasOwnProperty(t)},generate:function(){for(var t=Faye.random();this._used.hasOwnProperty(t);)t=Faye.random();return this._used[t]=t},release:function(t){delete this._used[t]}}),function(){var t,e=setTimeout;t="function"==typeof setImmediate?function(t){setImmediate(t)}:"object"==typeof process&&process.nextTick?function(t){process.nextTick(t)}:function(t){e(t,0)};var i=0,n=1,o=2,r=function(t){return t},s=function(t){throw t},a=function(t){if(this._state=i,this._onFulfilled=[],this._onRejected=[],"function"==typeof t){var e=this;t(function(t){d(e,t)},function(t){f(e,t)})}};a.prototype.then=function(t,e){var i=new a;return l(this,t,i),c(this,e,i),i};var l=function(t,e,o){"function"!=typeof e&&(e=r);var s=function(t){u(e,t,o)};t._state===i?t._onFulfilled.push(s):t._state===n&&s(t._value)},c=function(t,e,n){"function"!=typeof e&&(e=s);var r=function(t){u(e,t,n)};t._state===i?t._onRejected.push(r):t._state===o&&r(t._reason)},u=function(e,i,n){t(function(){h(e,i,n)})},h=function(t,e,i){var n;try{n=t(e)}catch(o){return f(i,o)}n===i?f(i,new TypeError("Recursive promise chain detected")):d(i,n)},d=a.fulfill=a.resolve=function(t,e){var i,n,o=!1;try{if(i=typeof e,n=null!==e&&("function"===i||"object"===i)&&e.then,"function"!=typeof n)return p(t,e);n.call(e,function(e){o^(o=!0)&&d(t,e)},function(e){o^(o=!0)&&f(t,e)})}catch(r){if(!(o^(o=!0)))return;f(t,r)}},p=function(t,e){if(t._state===i){t._state=n,t._value=e,t._onRejected=[];for(var o,r=t._onFulfilled;o=r.shift();)o(e)}},f=a.reject=function(t,e){if(t._state===i){t._state=o,t._reason=e,t._onFulfilled=[];for(var n,r=t._onRejected;n=r.shift();)n(e)}};a.all=function(t){return new a(function(e,i){var n,o=[],r=t.length;if(0===r)return e(o);for(n=0;r>n;n++)(function(t,n){a.fulfilled(t).then(function(t){o[n]=t,0===--r&&e(o)},i)})(t[n],n)})},a.defer=t,a.deferred=a.pending=function(){var t={};return t.promise=new a(function(e,i){t.fulfill=t.resolve=e,t.reject=i}),t},a.fulfilled=a.resolved=function(t){return new a(function(e){e(t)})},a.rejected=function(t){return new a(function(e,i){i(t)})},void 0===Faye?module.exports=a:Faye.Promise=a}(),Faye.Set=Faye.Class({initialize:function(){this._index={}},add:function(t){var e=void 0!==t.id?t.id:t;return this._index.hasOwnProperty(e)?!1:(this._index[e]=t,!0)},forEach:function(t,e){for(var i in this._index)this._index.hasOwnProperty(i)&&t.call(e,this._index[i])},isEmpty:function(){for(var t in this._index)if(this._index.hasOwnProperty(t))return!1;return!0},member:function(t){for(var e in this._index)if(this._index[e]===t)return!0;return!1},remove:function(t){var e=void 0!==t.id?t.id:t,i=this._index[e];return delete this._index[e],i},toArray:function(){var t=[];return this.forEach(function(e){t.push(e)}),t}}),Faye.URI={isURI:function(t){return t&&t.protocol&&t.host&&t.path},isSameOrigin:function(t){var e=Faye.ENV.location;return t.protocol===e.protocol&&t.hostname===e.hostname&&t.port===e.port},parse:function(t){if("string"!=typeof t)return t;var e,i,n,o,r,s,a={},l=function(e,i){t=t.replace(i,function(t){return a[e]=t,""}),a[e]=a[e]||""};for(l("protocol",/^[a-z]+\:/i),l("host",/^\/\/[^\/\?#]+/),/^\//.test(t)||a.host||(t=Faye.ENV.location.pathname.replace(/[^\/]*$/,"")+t),l("pathname",/^[^\?#]*/),l("search",/^\?[^#]*/),l("hash",/^#.*/),a.protocol=a.protocol||Faye.ENV.location.protocol,a.host?(a.host=a.host.substr(2),e=a.host.split(":"),a.hostname=e[0],a.port=e[1]||""):(a.host=Faye.ENV.location.host,a.hostname=Faye.ENV.location.hostname,a.port=Faye.ENV.location.port),a.pathname=a.pathname||"/",a.path=a.pathname+a.search,i=a.search.replace(/^\?/,""),n=i?i.split("&"):[],s={},o=0,r=n.length;r>o;o++)e=n[o].split("="),s[decodeURIComponent(e[0]||"")]=decodeURIComponent(e[1]||"");return a.query=s,a.href=this.stringify(a),a},stringify:function(t){var e=t.protocol+"//"+t.hostname;return t.port&&(e+=":"+t.port),e+=t.pathname+this.queryString(t.query)+(t.hash||"")},queryString:function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push(encodeURIComponent(i)+"="+encodeURIComponent(t[i]));return 0===e.length?"":"?"+e.join("&")}},Faye.Error=Faye.Class({initialize:function(t,e,i){this.code=t,this.params=Array.prototype.slice.call(e),this.message=i},toString:function(){return this.code+":"+this.params.join(",")+":"+this.message}}),Faye.Error.parse=function(t){if(t=t||"",!Faye.Grammar.ERROR.test(t))return new this(null,[],t);var e=t.split(":"),i=parseInt(e[0]),n=e[1].split(","),t=e[2];return new this(i,n,t)},Faye.Error.versionMismatch=function(){return""+new this(300,arguments,"Version mismatch")},Faye.Error.conntypeMismatch=function(){return""+new this(301,arguments,"Connection types not supported")},Faye.Error.extMismatch=function(){return""+new this(302,arguments,"Extension mismatch")},Faye.Error.badRequest=function(){return""+new this(400,arguments,"Bad request")},Faye.Error.clientUnknown=function(){return""+new this(401,arguments,"Unknown client")},Faye.Error.parameterMissing=function(){return""+new this(402,arguments,"Missing required parameter")},Faye.Error.channelForbidden=function(){return""+new this(403,arguments,"Forbidden channel")},Faye.Error.channelUnknown=function(){return""+new this(404,arguments,"Unknown channel")},Faye.Error.channelInvalid=function(){return""+new this(405,arguments,"Invalid channel")},Faye.Error.extUnknown=function(){return""+new this(406,arguments,"Unknown extension")},Faye.Error.publishFailed=function(){return""+new this(407,arguments,"Failed to publish")},Faye.Error.serverError=function(){return""+new this(500,arguments,"Internal server error")},Faye.Deferrable={then:function(t,e){var i=this;return this._promise||(this._promise=new Faye.Promise(function(t,e){i._fulfill=t,i._reject=e})),0===arguments.length?this._promise:this._promise.then(t,e)},callback:function(t,e){return this.then(function(i){t.call(e,i)})},errback:function(t,e){return this.then(null,function(i){t.call(e,i)})},timeout:function(t,e){this.then();var i=this;this._timer=Faye.ENV.setTimeout(function(){i._reject(e)},1e3*t)},setDeferredStatus:function(t,e){this._timer&&Faye.ENV.clearTimeout(this._timer),this.then(),"succeeded"===t?this._fulfill(e):"failed"===t?this._reject(e):delete this._promise}},Faye.Publisher={countListeners:function(t){return this.listeners(t).length},bind:function(t,e,i){var n=Array.prototype.slice,o=function(){e.apply(i,n.call(arguments))};return this._listeners=this._listeners||[],this._listeners.push([t,e,i,o]),this.on(t,o)},unbind:function(t,e,i){this._listeners=this._listeners||[];for(var n,o=this._listeners.length;o--;)n=this._listeners[o],n[0]===t&&(!e||n[1]===e&&n[2]===i)&&(this._listeners.splice(o,1),this.removeListener(t,n[3]))}},Faye.extend(Faye.Publisher,Faye.EventEmitter.prototype),Faye.Publisher.trigger=Faye.Publisher.emit,Faye.Timeouts={addTimeout:function(t,e,i,n){if(this._timeouts=this._timeouts||{},!this._timeouts.hasOwnProperty(t)){var o=this;this._timeouts[t]=Faye.ENV.setTimeout(function(){delete o._timeouts[t],i.call(n)},1e3*e)}},removeTimeout:function(t){this._timeouts=this._timeouts||{};var e=this._timeouts[t];e&&(Faye.ENV.clearTimeout(e),delete this._timeouts[t])},removeAllTimeouts:function(){this._timeouts=this._timeouts||{};for(var t in this._timeouts)this.removeTimeout(t)}},Faye.Logging={LOG_LEVELS:{fatal:4,error:3,warn:2,info:1,debug:0},writeLog:function(t,e){if(Faye.logger){var i=Array.prototype.slice.apply(t),n="[Faye",o=this.className,r=i.shift().replace(/\?/g,function(){try{return Faye.toJSON(i.shift())}catch(t){return"[Object]"}});for(var s in Faye)o||"function"==typeof Faye[s]&&this instanceof Faye[s]&&(o=s);o&&(n+="."+o),n+="] ","function"==typeof Faye.logger[e]?Faye.logger[e](n+r):"function"==typeof Faye.logger&&Faye.logger(n+r)}}},function(){for(var t in Faye.Logging.LOG_LEVELS)(function(t){Faye.Logging[t]=function(){this.writeLog(arguments,t)}})(t)}(),Faye.Grammar={CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*\/\*{1,2}$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*)*$/},Faye.Extensible={addExtension:function(t){this._extensions=this._extensions||[],this._extensions.push(t),t.added&&t.added(this)
},removeExtension:function(t){if(this._extensions)for(var e=this._extensions.length;e--;)this._extensions[e]===t&&(this._extensions.splice(e,1),t.removed&&t.removed(this))},pipeThroughExtensions:function(t,e,i,n,o){if(this.debug("Passing through ? extensions: ?",t,e),!this._extensions)return n.call(o,e);var r=this._extensions.slice(),s=function(e){if(!e)return n.call(o,e);var a=r.shift();if(!a)return n.call(o,e);var l=a[t];return l?void(l.length>=3?a[t](e,i,s):a[t](e,s)):s(e)};s(e)}},Faye.extend(Faye.Extensible,Faye.Logging),Faye.Channel=Faye.Class({initialize:function(t){this.id=this.name=t},push:function(t){this.trigger("message",t)},isUnused:function(){return 0===this.countListeners("message")}}),Faye.extend(Faye.Channel.prototype,Faye.Publisher),Faye.extend(Faye.Channel,{HANDSHAKE:"/meta/handshake",CONNECT:"/meta/connect",SUBSCRIBE:"/meta/subscribe",UNSUBSCRIBE:"/meta/unsubscribe",DISCONNECT:"/meta/disconnect",META:"meta",SERVICE:"service",expand:function(t){var e=this.parse(t),i=["/**",t],n=e.slice();n[n.length-1]="*",i.push(this.unparse(n));for(var o=1,r=e.length;r>o;o++)n=e.slice(0,o),n.push("**"),i.push(this.unparse(n));return i},isValid:function(t){return Faye.Grammar.CHANNEL_NAME.test(t)||Faye.Grammar.CHANNEL_PATTERN.test(t)},parse:function(t){return this.isValid(t)?t.split("/").slice(1):null},unparse:function(t){return"/"+t.join("/")},isMeta:function(t){var e=this.parse(t);return e?e[0]===this.META:null},isService:function(t){var e=this.parse(t);return e?e[0]===this.SERVICE:null},isSubscribable:function(t){return this.isValid(t)?!this.isMeta(t)&&!this.isService(t):null},Set:Faye.Class({initialize:function(){this._channels={}},getKeys:function(){var t=[];for(var e in this._channels)t.push(e);return t},remove:function(t){delete this._channels[t]},hasSubscription:function(t){return this._channels.hasOwnProperty(t)},subscribe:function(t,e,i){for(var n,o=0,r=t.length;r>o;o++){n=t[o];var s=this._channels[n]=this._channels[n]||new Faye.Channel(n);e&&s.bind("message",e,i)}},unsubscribe:function(t,e,i){var n=this._channels[t];return n?(n.unbind("message",e,i),n.isUnused()?(this.remove(t),!0):!1):!1},distributeMessage:function(t){for(var e=Faye.Channel.expand(t.channel),i=0,n=e.length;n>i;i++){var o=this._channels[e[i]];o&&o.trigger("message",t.data)}}})}),Faye.Publication=Faye.Class(Faye.Deferrable),Faye.Subscription=Faye.Class({initialize:function(t,e,i,n){this._client=t,this._channels=e,this._callback=i,this._context=n,this._cancelled=!1},cancel:function(){this._cancelled||(this._client.unsubscribe(this._channels,this._callback,this._context),this._cancelled=!0)},unsubscribe:function(){this.cancel()}}),Faye.extend(Faye.Subscription.prototype,Faye.Deferrable),Faye.Client=Faye.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:"handshake",RETRY:"retry",NONE:"none",CONNECTION_TIMEOUT:60,DEFAULT_ENDPOINT:"/bayeux",INTERVAL:0,initialize:function(t,e){this.info("New client created for ?",t),e=e||{},Faye.validateOptions(e,["interval","timeout","endpoints","proxy","retry","scheduler","websocketExtensions","tls","ca"]),this._endpoint=t||this.DEFAULT_ENDPOINT,this._channels=new Faye.Channel.Set,this._dispatcher=new Faye.Dispatcher(this,this._endpoint,e),this._messageId=0,this._state=this.UNCONNECTED,this._responseCallbacks={},this._advice={reconnect:this.RETRY,interval:1e3*(e.interval||this.INTERVAL),timeout:1e3*(e.timeout||this.CONNECTION_TIMEOUT)},this._dispatcher.timeout=this._advice.timeout/1e3,this._dispatcher.bind("message",this._receiveMessage,this),Faye.Event&&void 0!==Faye.ENV.onbeforeunload&&Faye.Event.on(Faye.ENV,"beforeunload",function(){Faye.indexOf(this._dispatcher._disabled,"autodisconnect")<0&&this.disconnect()},this)},addWebsocketExtension:function(t){return this._dispatcher.addWebsocketExtension(t)},disable:function(t){return this._dispatcher.disable(t)},setHeader:function(t,e){return this._dispatcher.setHeader(t,e)},handshake:function(t,e){if(this._advice.reconnect!==this.NONE&&this._state===this.UNCONNECTED){this._state=this.CONNECTING;var i=this;this.info("Initiating handshake with ?",Faye.URI.stringify(this._endpoint)),this._dispatcher.selectTransport(Faye.MANDATORY_CONNECTION_TYPES),this._sendMessage({channel:Faye.Channel.HANDSHAKE,version:Faye.BAYEUX_VERSION,supportedConnectionTypes:this._dispatcher.getConnectionTypes()},{},function(n){n.successful?(this._state=this.CONNECTED,this._dispatcher.clientId=n.clientId,this._dispatcher.selectTransport(n.supportedConnectionTypes),this.info("Handshake successful: ?",this._dispatcher.clientId),this.subscribe(this._channels.getKeys(),!0),t&&Faye.Promise.defer(function(){t.call(e)})):(this.info("Handshake unsuccessful"),Faye.ENV.setTimeout(function(){i.handshake(t,e)},1e3*this._dispatcher.retry),this._state=this.UNCONNECTED)},this)}},connect:function(t,e){if(this._advice.reconnect!==this.NONE&&this._state!==this.DISCONNECTED){if(this._state===this.UNCONNECTED)return this.handshake(function(){this.connect(t,e)},this);this.callback(t,e),this._state===this.CONNECTED&&(this.info("Calling deferred actions for ?",this._dispatcher.clientId),this.setDeferredStatus("succeeded"),this.setDeferredStatus("unknown"),this._connectRequest||(this._connectRequest=!0,this.info("Initiating connection for ?",this._dispatcher.clientId),this._sendMessage({channel:Faye.Channel.CONNECT,clientId:this._dispatcher.clientId,connectionType:this._dispatcher.connectionType},{},this._cycleConnection,this)))}},disconnect:function(){if(this._state===this.CONNECTED){this._state=this.DISCONNECTED,this.info("Disconnecting ?",this._dispatcher.clientId);var t=new Faye.Publication;return this._sendMessage({channel:Faye.Channel.DISCONNECT,clientId:this._dispatcher.clientId},{},function(e){e.successful?(this._dispatcher.close(),t.setDeferredStatus("succeeded")):t.setDeferredStatus("failed",Faye.Error.parse(e.error))},this),this.info("Clearing channel listeners for ?",this._dispatcher.clientId),this._channels=new Faye.Channel.Set,t}},subscribe:function(t,e,i){if(t instanceof Array)return Faye.map(t,function(t){return this.subscribe(t,e,i)},this);var n=new Faye.Subscription(this,t,e,i),o=e===!0,r=this._channels.hasSubscription(t);return r&&!o?(this._channels.subscribe([t],e,i),n.setDeferredStatus("succeeded"),n):(this.connect(function(){this.info("Client ? attempting to subscribe to ?",this._dispatcher.clientId,t),o||this._channels.subscribe([t],e,i),this._sendMessage({channel:Faye.Channel.SUBSCRIBE,clientId:this._dispatcher.clientId,subscription:t},{},function(o){if(!o.successful)return n.setDeferredStatus("failed",Faye.Error.parse(o.error)),this._channels.unsubscribe(t,e,i);var r=[].concat(o.subscription);this.info("Subscription acknowledged for ? to ?",this._dispatcher.clientId,r),n.setDeferredStatus("succeeded")},this)},this),n)},unsubscribe:function(t,e,i){if(t instanceof Array)return Faye.map(t,function(t){return this.unsubscribe(t,e,i)},this);var n=this._channels.unsubscribe(t,e,i);n&&this.connect(function(){this.info("Client ? attempting to unsubscribe from ?",this._dispatcher.clientId,t),this._sendMessage({channel:Faye.Channel.UNSUBSCRIBE,clientId:this._dispatcher.clientId,subscription:t},{},function(t){if(t.successful){var e=[].concat(t.subscription);this.info("Unsubscription acknowledged for ? from ?",this._dispatcher.clientId,e)}},this)},this)},publish:function(t,e,i){Faye.validateOptions(i||{},["attempts","deadline"]);var n=new Faye.Publication;return this.connect(function(){this.info("Client ? queueing published message to ?: ?",this._dispatcher.clientId,t,e),this._sendMessage({channel:t,data:e,clientId:this._dispatcher.clientId},i,function(t){t.successful?n.setDeferredStatus("succeeded"):n.setDeferredStatus("failed",Faye.Error.parse(t.error))},this)},this),n},_sendMessage:function(t,e,i,n){t.id=this._generateMessageId();var o=this._advice.timeout?1.2*this._advice.timeout/1e3:1.2*this._dispatcher.retry;this.pipeThroughExtensions("outgoing",t,null,function(t){t&&(i&&(this._responseCallbacks[t.id]=[i,n]),this._dispatcher.sendMessage(t,o,e||{}))},this)},_generateMessageId:function(){return this._messageId+=1,this._messageId>=Math.pow(2,32)&&(this._messageId=0),this._messageId.toString(36)},_receiveMessage:function(t){var e,i=t.id;void 0!==t.successful&&(e=this._responseCallbacks[i],delete this._responseCallbacks[i]),this.pipeThroughExtensions("incoming",t,null,function(t){t&&(t.advice&&this._handleAdvice(t.advice),this._deliverMessage(t),e&&e[0].call(e[1],t))},this)},_handleAdvice:function(t){Faye.extend(this._advice,t),this._dispatcher.timeout=this._advice.timeout/1e3,this._advice.reconnect===this.HANDSHAKE&&this._state!==this.DISCONNECTED&&(this._state=this.UNCONNECTED,this._dispatcher.clientId=null,this._cycleConnection())},_deliverMessage:function(t){t.channel&&void 0!==t.data&&(this.info("Client ? calling listeners for ? with ?",this._dispatcher.clientId,t.channel,t.data),this._channels.distributeMessage(t))},_cycleConnection:function(){this._connectRequest&&(this._connectRequest=null,this.info("Closed connection for ?",this._dispatcher.clientId));var t=this;Faye.ENV.setTimeout(function(){t.connect()},this._advice.interval)}}),Faye.extend(Faye.Client.prototype,Faye.Deferrable),Faye.extend(Faye.Client.prototype,Faye.Publisher),Faye.extend(Faye.Client.prototype,Faye.Logging),Faye.extend(Faye.Client.prototype,Faye.Extensible),Faye.Dispatcher=Faye.Class({MAX_REQUEST_SIZE:2048,DEFAULT_RETRY:5,UP:1,DOWN:2,initialize:function(t,e,i){this._client=t,this.endpoint=Faye.URI.parse(e),this._alternates=i.endpoints||{},this.cookies=Faye.Cookies&&new Faye.Cookies.CookieJar,this._disabled=[],this._envelopes={},this.headers={},this.retry=i.retry||this.DEFAULT_RETRY,this._scheduler=i.scheduler||Faye.Scheduler,this._state=0,this.transports={},this.wsExtensions=[],this.proxy=i.proxy||{},"string"==typeof this._proxy&&(this._proxy={origin:this._proxy});var n=i.websocketExtensions;if(n){n=[].concat(n);for(var o=0,r=n.length;r>o;o++)this.addWebsocketExtension(n[o])}this.tls=i.tls||{},this.tls.ca=this.tls.ca||i.ca;for(var s in this._alternates)this._alternates[s]=Faye.URI.parse(this._alternates[s]);this.maxRequestSize=this.MAX_REQUEST_SIZE},endpointFor:function(t){return this._alternates[t]||this.endpoint},addWebsocketExtension:function(t){this.wsExtensions.push(t)},disable:function(t){this._disabled.push(t)},setHeader:function(t,e){this.headers[t]=e},close:function(){var t=this._transport;delete this._transport,t&&t.close()},getConnectionTypes:function(){return Faye.Transport.getConnectionTypes()},selectTransport:function(t){Faye.Transport.get(this,t,this._disabled,function(t){this.debug("Selected ? transport for ?",t.connectionType,Faye.URI.stringify(t.endpoint)),t!==this._transport&&(this._transport&&this._transport.close(),this._transport=t,this.connectionType=t.connectionType)},this)},sendMessage:function(t,e,i){i=i||{};var n,o=t.id,r=i.attempts,s=i.deadline&&(new Date).getTime()+1e3*i.deadline,a=this._envelopes[o];a||(n=new this._scheduler(t,{timeout:e,interval:this.retry,attempts:r,deadline:s}),a=this._envelopes[o]={message:t,scheduler:n}),this._sendEnvelope(a)},_sendEnvelope:function(t){if(this._transport&&!t.request&&!t.timer){var e=t.message,i=t.scheduler,n=this;if(!i.isDeliverable())return i.abort(),void delete this._envelopes[e.id];t.timer=Faye.ENV.setTimeout(function(){n.handleError(e)},1e3*i.getTimeout()),i.send(),t.request=this._transport.sendMessage(e)}},handleResponse:function(t){var e=this._envelopes[t.id];void 0!==t.successful&&e&&(e.scheduler.succeed(),delete this._envelopes[t.id],Faye.ENV.clearTimeout(e.timer)),this.trigger("message",t),this._state!==this.UP&&(this._state=this.UP,this._client.trigger("transport:up"))},handleError:function(t,e){var i=this._envelopes[t.id],n=i&&i.request,o=this;if(n){n.then(function(t){t&&t.abort&&t.abort()});var r=i.scheduler;r.fail(),Faye.ENV.clearTimeout(i.timer),i.request=i.timer=null,e?this._sendEnvelope(i):i.timer=Faye.ENV.setTimeout(function(){i.timer=null,o._sendEnvelope(i)},1e3*r.getInterval()),this._state!==this.DOWN&&(this._state=this.DOWN,this._client.trigger("transport:down"))}}}),Faye.extend(Faye.Dispatcher.prototype,Faye.Publisher),Faye.extend(Faye.Dispatcher.prototype,Faye.Logging),Faye.Scheduler=function(t,e){this.message=t,this.options=e,this.attempts=0},Faye.extend(Faye.Scheduler.prototype,{getTimeout:function(){return this.options.timeout},getInterval:function(){return this.options.interval},isDeliverable:function(){var t=this.options.attempts,e=this.attempts,i=this.options.deadline,n=(new Date).getTime();return void 0!==t&&e>=t?!1:void 0!==i&&n>i?!1:!0},send:function(){this.attempts+=1},succeed:function(){},fail:function(){},abort:function(){}}),Faye.Transport=Faye.extend(Faye.Class({DEFAULT_PORTS:{"http:":80,"https:":443,"ws:":80,"wss:":443},SECURE_PROTOCOLS:["https:","wss:"],MAX_DELAY:0,batching:!0,initialize:function(t,e){this._dispatcher=t,this.endpoint=e,this._outbox=[],this._proxy=Faye.extend({},this._dispatcher.proxy),!this._proxy.origin&&Faye.NodeAdapter&&(this._proxy.origin=Faye.indexOf(this.SECURE_PROTOCOLS,this.endpoint.protocol)>=0?process.env.HTTPS_PROXY||process.env.https_proxy:process.env.HTTP_PROXY||process.env.http_proxy)},close:function(){},encode:function(){return""},sendMessage:function(t){return this.debug("Client ? sending message to ?: ?",this._dispatcher.clientId,Faye.URI.stringify(this.endpoint),t),this.batching?(this._outbox.push(t),this._flushLargeBatch(),this._promise=this._promise||new Faye.Promise,t.channel===Faye.Channel.HANDSHAKE?(this.addTimeout("publish",.01,this._flush,this),this._promise):(t.channel===Faye.Channel.CONNECT&&(this._connectMessage=t),this.addTimeout("publish",this.MAX_DELAY,this._flush,this),this._promise)):Faye.Promise.fulfilled(this.request([t]))},_flush:function(){this.removeTimeout("publish"),this._outbox.length>1&&this._connectMessage&&(this._connectMessage.advice={timeout:0}),Faye.Promise.fulfill(this._promise,this.request(this._outbox)),delete this._promise,this._connectMessage=null,this._outbox=[]},_flushLargeBatch:function(){var t=this.encode(this._outbox);if(!(t.length<this._dispatcher.maxRequestSize)){var e=this._outbox.pop();this._flush(),e&&this._outbox.push(e)}},_receive:function(t){if(t){t=[].concat(t),this.debug("Client ? received from ? via ?: ?",this._dispatcher.clientId,Faye.URI.stringify(this.endpoint),this.connectionType,t);for(var e=0,i=t.length;i>e;e++)this._dispatcher.handleResponse(t[e])}},_handleError:function(t){t=[].concat(t),this.debug("Client ? failed to send to ? via ?: ?",this._dispatcher.clientId,Faye.URI.stringify(this.endpoint),this.connectionType,t);for(var e=0,i=t.length;i>e;e++)this._dispatcher.handleError(t[e])},_getCookies:function(){var t=this._dispatcher.cookies,e=Faye.URI.stringify(this.endpoint);return t?Faye.map(t.getCookiesSync(e),function(t){return t.cookieString()}).join("; "):""},_storeCookies:function(t){var e,i=this._dispatcher.cookies,n=Faye.URI.stringify(this.endpoint);if(t&&i){t=[].concat(t);for(var o=0,r=t.length;r>o;o++)e=Faye.Cookies.Cookie.parse(t[o]),i.setCookieSync(e,n)}}}),{get:function(t,e,i,n,o){var r=t.endpoint;Faye.asyncEach(this._transports,function(r,s){var a=r[0],l=r[1],c=t.endpointFor(a);return Faye.indexOf(i,a)>=0?s():Faye.indexOf(e,a)<0?(l.isUsable(t,c,function(){}),s()):void l.isUsable(t,c,function(e){if(!e)return s();var i=l.hasOwnProperty("create")?l.create(t,c):new l(t,c);n.call(o,i)})},function(){throw Error("Could not find a usable connection type for "+Faye.URI.stringify(r))})},register:function(t,e){this._transports.push([t,e]),e.prototype.connectionType=t},getConnectionTypes:function(){return Faye.map(this._transports,function(t){return t[0]})},_transports:[]}),Faye.extend(Faye.Transport.prototype,Faye.Logging),Faye.extend(Faye.Transport.prototype,Faye.Timeouts),Faye.Event={_registry:[],on:function(t,e,i,n){var o=function(){i.call(n)};t.addEventListener?t.addEventListener(e,o,!1):t.attachEvent("on"+e,o),this._registry.push({_element:t,_type:e,_callback:i,_context:n,_handler:o})},detach:function(t,e,i,n){for(var o,r=this._registry.length;r--;)o=this._registry[r],t&&t!==o._element||e&&e!==o._type||i&&i!==o._callback||n&&n!==o._context||(o._element.removeEventListener?o._element.removeEventListener(o._type,o._handler,!1):o._element.detachEvent("on"+o._type,o._handler),this._registry.splice(r,1),o=null)}},void 0!==Faye.ENV.onunload&&Faye.Event.on(Faye.ENV,"unload",Faye.Event.detach,Faye.Event),"object"!=typeof JSON&&(JSON={}),function(){function f(t){return 10>t?"0"+t:t}function quote(t){return escapable.lastIndex=0,escapable.test(t)?'"'+t.replace(escapable,function(t){var e=meta[t];return"string"==typeof e?e:"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+t+'"'}function str(t,e){var i,n,o,r,s,a=gap,l=e[t];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(t)),"function"==typeof rep&&(l=rep.call(e,t,l)),typeof l){case"string":return quote(l);case"number":return isFinite(l)?l+"":"null";case"boolean":case"null":return l+"";case"object":if(!l)return"null";if(gap+=indent,s=[],"[object Array]"===Object.prototype.toString.apply(l)){for(r=l.length,i=0;r>i;i+=1)s[i]=str(i,l)||"null";return o=0===s.length?"[]":gap?"[\n"+gap+s.join(",\n"+gap)+"\n"+a+"]":"["+s.join(",")+"]",gap=a,o}if(rep&&"object"==typeof rep)for(r=rep.length,i=0;r>i;i+=1)"string"==typeof rep[i]&&(n=rep[i],o=str(n,l),o&&s.push(quote(n)+(gap?": ":":")+o));else for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(o=str(n,l),o&&s.push(quote(n)+(gap?": ":":")+o));return o=0===s.length?"{}":gap?"{\n"+gap+s.join(",\n"+gap)+"\n"+a+"}":"{"+s.join(",")+"}",gap=a,o}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;Faye.stringify=function(t,e,i){var n;if(gap="",indent="","number"==typeof i)for(n=0;i>n;n+=1)indent+=" ";else"string"==typeof i&&(indent=i);if(rep=e,e&&"function"!=typeof e&&("object"!=typeof e||"number"!=typeof e.length))throw Error("JSON.stringify");return str("",{"":t})},"function"!=typeof JSON.stringify&&(JSON.stringify=Faye.stringify),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(t,e){var i,n,o=t[e];if(o&&"object"==typeof o)for(i in o)Object.prototype.hasOwnProperty.call(o,i)&&(n=walk(o,i),void 0!==n?o[i]=n:delete o[i]);return reviver.call(t,e,o)}var j;if(text+="",cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(t){return"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),Faye.Transport.WebSocket=Faye.extend(Faye.Class(Faye.Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:!1,isUsable:function(t,e){this.callback(function(){t.call(e,!0)}),this.errback(function(){t.call(e,!1)}),this.connect()},request:function(t){this._pending=this._pending||new Faye.Set;for(var e=0,i=t.length;i>e;e++)this._pending.add(t[e]);var n=new Faye.Promise;return this.callback(function(e){e&&(e.send(Faye.toJSON(t)),Faye.Promise.fulfill(n,e))},this),this.connect(),{abort:function(){n.then(function(t){t.close()})}}},connect:function(){if(!Faye.Transport.WebSocket._unloaded&&(this._state=this._state||this.UNCONNECTED,this._state===this.UNCONNECTED)){this._state=this.CONNECTING;var t=this._createSocket();if(!t)return this.setDeferredStatus("failed");var e=this;t.onopen=function(){t.headers&&e._storeCookies(t.headers["set-cookie"]),e._socket=t,e._state=e.CONNECTED,e._everConnected=!0,e._ping(),e.setDeferredStatus("succeeded",t)};var i=!1;t.onclose=t.onerror=function(){if(!i){i=!0;var n=e._state===e.CONNECTED;t.onopen=t.onclose=t.onerror=t.onmessage=null,delete e._socket,e._state=e.UNCONNECTED,e.removeTimeout("ping"),e.setDeferredStatus("unknown");var o=e._pending?e._pending.toArray():[];delete e._pending,n?e._handleError(o,!0):e._everConnected?e._handleError(o):e.setDeferredStatus("failed")}},t.onmessage=function(t){var i=JSON.parse(t.data);if(i){i=[].concat(i);for(var n=0,o=i.length;o>n;n++)void 0!==i[n].successful&&e._pending.remove(i[n]);e._receive(i)}}}},close:function(){this._socket&&this._socket.close()},_createSocket:function(){var t=Faye.Transport.WebSocket.getSocketUrl(this.endpoint),e=this._dispatcher.headers,i=this._dispatcher.wsExtensions,n=this._getCookies(),o=this._dispatcher.tls,r={extensions:i,headers:e,proxy:this._proxy,tls:o};return""!==n&&(r.headers.Cookie=n),Faye.WebSocket?new Faye.WebSocket.Client(t,[],r):Faye.ENV.MozWebSocket?new MozWebSocket(t):Faye.ENV.WebSocket?new WebSocket(t):void 0},_ping:function(){this._socket&&(this._socket.send("[]"),this.addTimeout("ping",this._dispatcher.timeout/2,this._ping,this))}}),{PROTOCOLS:{"http:":"ws:","https:":"wss:"},create:function(t,e){var i=t.transports.websocket=t.transports.websocket||{};return i[e.href]=i[e.href]||new this(t,e),i[e.href]},getSocketUrl:function(t){return t=Faye.copyObject(t),t.protocol=this.PROTOCOLS[t.protocol],Faye.URI.stringify(t)},isUsable:function(t,e,i,n){this.create(t,e).isUsable(i,n)}}),Faye.extend(Faye.Transport.WebSocket.prototype,Faye.Deferrable),Faye.Transport.register("websocket",Faye.Transport.WebSocket),Faye.Event&&void 0!==Faye.ENV.onbeforeunload&&Faye.Event.on(Faye.ENV,"beforeunload",function(){Faye.Transport.WebSocket._unloaded=!0}),Faye.Transport.EventSource=Faye.extend(Faye.Class(Faye.Transport,{initialize:function(t,e){if(Faye.Transport.prototype.initialize.call(this,t,e),!Faye.ENV.EventSource)return this.setDeferredStatus("failed");this._xhr=new Faye.Transport.XHR(t,e),e=Faye.copyObject(e),e.pathname+="/"+t.clientId;var i=new EventSource(Faye.URI.stringify(e)),n=this;i.onopen=function(){n._everConnected=!0,n.setDeferredStatus("succeeded")},i.onerror=function(){n._everConnected?n._handleError([]):(n.setDeferredStatus("failed"),i.close())},i.onmessage=function(t){n._receive(JSON.parse(t.data))},this._socket=i},close:function(){this._socket&&(this._socket.onopen=this._socket.onerror=this._socket.onmessage=null,this._socket.close(),delete this._socket)},isUsable:function(t,e){this.callback(function(){t.call(e,!0)}),this.errback(function(){t.call(e,!1)})},encode:function(t){return this._xhr.encode(t)},request:function(t){return this._xhr.request(t)}}),{isUsable:function(t,e,i,n){var o=t.clientId;return o?void Faye.Transport.XHR.isUsable(t,e,function(o){return o?void this.create(t,e).isUsable(i,n):i.call(n,!1)},this):i.call(n,!1)},create:function(t,e){var i=t.transports.eventsource=t.transports.eventsource||{},n=t.clientId,o=Faye.copyObject(e);return o.pathname+="/"+(n||""),o=Faye.URI.stringify(o),i[o]=i[o]||new this(t,e),i[o]}}),Faye.extend(Faye.Transport.EventSource.prototype,Faye.Deferrable),Faye.Transport.register("eventsource",Faye.Transport.EventSource),Faye.Transport.XHR=Faye.extend(Faye.Class(Faye.Transport,{encode:function(t){return Faye.toJSON(t)},request:function(t){var e=this.endpoint.href,i=Faye.ENV.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest,n=this;i.open("POST",e,!0),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("Pragma","no-cache"),i.setRequestHeader("X-Requested-With","XMLHttpRequest");var o=this._dispatcher.headers;for(var r in o)o.hasOwnProperty(r)&&i.setRequestHeader(r,o[r]);var s=function(){i.abort()};return void 0!==Faye.ENV.onbeforeunload&&Faye.Event.on(Faye.ENV,"beforeunload",s),i.onreadystatechange=function(){if(i&&4===i.readyState){var e=null,o=i.status,r=i.responseText,a=o>=200&&300>o||304===o||1223===o;if(void 0!==Faye.ENV.onbeforeunload&&Faye.Event.detach(Faye.ENV,"beforeunload",s),i.onreadystatechange=function(){},i=null,!a)return n._handleError(t);try{e=JSON.parse(r)}catch(l){}e?n._receive(e):n._handleError(t)}},i.send(this.encode(t)),i}}),{isUsable:function(t,e,i,n){i.call(n,Faye.URI.isSameOrigin(e))}}),Faye.Transport.register("long-polling",Faye.Transport.XHR),Faye.Transport.CORS=Faye.extend(Faye.Class(Faye.Transport,{encode:function(t){return"message="+encodeURIComponent(Faye.toJSON(t))},request:function(t){var e,i=Faye.ENV.XDomainRequest?XDomainRequest:XMLHttpRequest,n=new i,o=this._dispatcher.headers,r=this;if(n.open("POST",Faye.URI.stringify(this.endpoint),!0),n.setRequestHeader){n.setRequestHeader("Pragma","no-cache");for(e in o)o.hasOwnProperty(e)&&n.setRequestHeader(e,o[e])}var s=function(){return n?(n.onload=n.onerror=n.ontimeout=n.onprogress=null,void(n=null)):!1};return n.onload=function(){var e=null;try{e=JSON.parse(n.responseText)}catch(i){}s(),e?r._receive(e):r._handleError(t)},n.onerror=n.ontimeout=function(){s(),r._handleError(t)},n.onprogress=function(){},n.send(this.encode(t)),n}}),{isUsable:function(t,e,i,n){if(Faye.URI.isSameOrigin(e))return i.call(n,!1);if(Faye.ENV.XDomainRequest)return i.call(n,e.protocol===Faye.ENV.location.protocol);if(Faye.ENV.XMLHttpRequest){var o=new Faye.ENV.XMLHttpRequest;return i.call(n,void 0!==o.withCredentials)}return i.call(n,!1)}}),Faye.Transport.register("cross-origin-long-polling",Faye.Transport.CORS),Faye.Transport.JSONP=Faye.extend(Faye.Class(Faye.Transport,{encode:function(t){var e=Faye.copyObject(this.endpoint);return e.query.message=Faye.toJSON(t),e.query.jsonp="__jsonp"+Faye.Transport.JSONP._cbCount+"__",Faye.URI.stringify(e)},request:function(t){var e=document.getElementsByTagName("head")[0],i=document.createElement("script"),n=Faye.Transport.JSONP.getCallbackName(),o=Faye.copyObject(this.endpoint),r=this;o.query.message=Faye.toJSON(t),o.query.jsonp=n;var s=function(){if(!Faye.ENV[n])return!1;Faye.ENV[n]=void 0;try{delete Faye.ENV[n]}catch(t){}i.parentNode.removeChild(i)};return Faye.ENV[n]=function(t){s(),r._receive(t)},i.type="text/javascript",i.src=Faye.URI.stringify(o),e.appendChild(i),i.onerror=function(){s(),r._handleError(t)},{abort:s}}}),{_cbCount:0,getCallbackName:function(){return this._cbCount+=1,"__jsonp"+this._cbCount+"__"},isUsable:function(t,e,i,n){i.call(n,!0)}}),Faye.Transport.register("callback-polling",Faye.Transport.JSONP)}()}(this);var allokaDevelopment=!1;allokaBindReady(allokaInit),geoInit(),loadModal();var _alloka_defer={},allokaSendCustomData=allokaSendCustomDataDefer;document.getElementsByClassName||(document.getElementsByClassName=function(t){for(var e=[],i=document.getElementsByTagName("*"),n=new RegExp("(^|\\s)"+t+"(\\s|$)"),o=0;o<i.length;o++)n.test(i[o].className)&&e.push(i[o]);return e}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(t,e){void 0===e&&(e=0),0>e&&(e+=this.length),0>e&&(e=0);for(var i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});try{var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var e,i,n,o,r,s,a,l="",c=0;for(t=Base64._utf8_encode(t);c<t.length;)e=t.charCodeAt(c++),i=t.charCodeAt(c++),n=t.charCodeAt(c++),o=e>>2,r=(3&e)<<4|i>>4,s=(15&i)<<2|n>>6,a=63&n,isNaN(i)?s=a=64:isNaN(n)&&(a=64),l=l+Base64._keyStr.charAt(o)+Base64._keyStr.charAt(r)+Base64._keyStr.charAt(s)+Base64._keyStr.charAt(a);return l},decode:function(t){var e,i,n,o,r,s,a,l="",c=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<t.length;)o=Base64._keyStr.indexOf(t.charAt(c++)),r=Base64._keyStr.indexOf(t.charAt(c++)),s=Base64._keyStr.indexOf(t.charAt(c++)),a=Base64._keyStr.indexOf(t.charAt(c++)),e=o<<2|r>>4,i=(15&r)<<4|s>>2,n=(3&s)<<6|a,l+=String.fromCharCode(e),64!=s&&(l+=String.fromCharCode(i)),64!=a&&(l+=String.fromCharCode(n));return l=Base64._utf8_decode(l)},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var e="",i=0;i<t.length;i++){var n=t.charCodeAt(i);128>n?e+=String.fromCharCode(n):n>127&&2048>n?(e+=String.fromCharCode(n>>6|192),e+=String.fromCharCode(63&n|128)):(e+=String.fromCharCode(n>>12|224),e+=String.fromCharCode(n>>6&63|128),e+=String.fromCharCode(63&n|128))}return e},_utf8_decode:function(t){for(var e="",i=0,n=c1=c2=0;i<t.length;)n=t.charCodeAt(i),128>n?(e+=String.fromCharCode(n),i++):n>191&&224>n?(c2=t.charCodeAt(i+1),e+=String.fromCharCode((31&n)<<6|63&c2),i+=2):(c2=t.charCodeAt(i+1),c3=t.charCodeAt(i+2),e+=String.fromCharCode((15&n)<<12|(63&c2)<<6|63&c3),i+=3);return e}};"object"!=typeof JSON&&(JSON={}),function(){"use strict";function f(t){return 10>t?"0"+t:t}function quote(t){return escapable.lastIndex=0,escapable.test(t)?'"'+t.replace(escapable,function(t){var e=meta[t];return"string"==typeof e?e:"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+t+'"'}function str(t,e){var i,n,o,r,s,a=gap,l=e[t];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(t)),"function"==typeof rep&&(l=rep.call(e,t,l)),typeof l){case"string":return quote(l);case"number":return isFinite(l)?String(l):"null";case"boolean":case"null":return String(l);case"object":if(!l)return"null";if(gap+=indent,s=[],"[object Array]"===Object.prototype.toString.apply(l)){for(r=l.length,i=0;r>i;i+=1)s[i]=str(i,l)||"null";return o=0===s.length?"[]":gap?"[\n"+gap+s.join(",\n"+gap)+"\n"+a+"]":"["+s.join(",")+"]",gap=a,o}if(rep&&"object"==typeof rep)for(r=rep.length,i=0;r>i;i+=1)"string"==typeof rep[i]&&(n=rep[i],o=str(n,l),o&&s.push(quote(n)+(gap?": ":":")+o));else for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(o=str(n,l),o&&s.push(quote(n)+(gap?": ":":")+o));return o=0===s.length?"{}":gap?"{\n"+gap+s.join(",\n"+gap)+"\n"+a+"}":"{"+s.join(",")+"}",gap=a,o}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx,escapable,gap,indent,meta,rep;"function"!=typeof JSON.stringify&&(escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},JSON.stringify=function(t,e,i){var n;if(gap="",indent="","number"==typeof i)for(n=0;i>n;n+=1)indent+=" ";else"string"==typeof i&&(indent=i);if(rep=e,e&&"function"!=typeof e&&("object"!=typeof e||"number"!=typeof e.length))throw new Error("JSON.stringify");return str("",{"":t})}),"function"!=typeof JSON.parse&&(cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,JSON.parse=function(text,reviver){function walk(t,e){var i,n,o=t[e];if(o&&"object"==typeof o)for(i in o)Object.prototype.hasOwnProperty.call(o,i)&&(n=walk(o,i),void 0!==n?o[i]=n:delete o[i]);return reviver.call(t,e,o)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(t){return"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}()}catch(error){allokaLog(error)}/*!
 * jsModal - A pure JavaScript modal dialog engine v1.0d
 * http://jsmodal.com/
 *
 * Author: Henry Rune Tang Kai <henry@henrys.se>
 *
 * (c) Copyright 2013 Henry Tang Kai.
 *
 * License: http://www.opensource.org/licenses/mit-license.php
 *
 * Date: 2013-7-11
 */
var Modal=function(){"use strict";var t,e,i={},n={},o=document.createElement("div"),r=document.createElement("div"),s=document.createElement("div"),a=document.createElement("div"),l=document.createElement("div"),c={width:"auto",height:"auto",lock:!1,hideClose:!1,draggable:!1,closeAfter:0,openCallback:!1,closeCallback:!1,hideOverlay:!1};return i.open=function(u){n.width=u.width||c.width,n.height=u.height||c.height,n.lock=u.lock||c.lock,n.hideClose=u.hideClose||c.hideClose,n.draggable=u.draggable||c.draggable,n.closeAfter=u.closeAfter||c.closeAfter,n.closeCallback=u.closeCallback||c.closeCallback,n.openCallback=u.openCallback||c.openCallback,n.hideOverlay=u.hideOverlay||c.hideOverlay,t=function(){i.center({})},u.content&&!u.ajaxContent?a.innerHTML=u.content:u.ajaxContent&&!u.content?(r.className="modal-loading",i.ajax(u.ajaxContent,function(t){a.innerHTML=t})):a.innerHTML="",r.style.width=n.width,r.style.height=n.height,i.center({}),(n.lock||n.hideClose)&&(l.style.visibility="hidden"),n.hideOverlay||(o.style.visibility="visible"),r.style.display=null,t(),document.onkeypress=function(t){27===t.keyCode&&n.lock!==!0&&i.close()},l.onclick=function(){return n.hideClose?!1:void i.close()},o.onclick=function(){return n.lock?!1:void i.close()},window.addEventListener?window.addEventListener("resize",t,!1):window.attachEvent&&window.attachEvent("onresize",t),n.draggable?(s.style.cursor="move",s.onmousedown=function(t){return i.drag(t),!1}):s.onmousedown=function(){return!1},n.closeAfter>0&&(e=window.setTimeout(function(){i.close()},1e3*n.closeAfter)),n.openCallback&&n.openCallback()},i.drag=function(t){var e=void 0!==window.event?window.event.clientX:t.clientX,i=void 0!==window.event?window.event.clientY:t.clientY,n=e-r.offsetLeft,o=i-r.offsetTop;document.onmousemove=function(t){e=void 0!==window.event?window.event.clientX:t.clientX,i=void 0!==window.event?window.event.clientY:t.clientY,r.style.left=e-n>0?e-n+"px":0,r.style.top=i-o>0?i-o+"px":0,document.onmouseup=function(){window.document.onmousemove=null}}},i.ajax=function(t,e){var i,n=!1,o=[function(){return new window.XMLHttpRequest},function(){return new window.ActiveXObject("Msxml2.XMLHTTP.6.0")},function(){return new window.ActiveXObject("Msxml2.XMLHTTP.3.0")},function(){return new window.ActiveXObject("Msxml2.XMLHTTP")}];for(i=0;i<o.length;i+=1){try{n=o[i]()}catch(s){}if(n!==!1)break}n.open("GET",t,!0),n.onreadystatechange=function(){4===n.readyState&&(200===n.status?(e(n.responseText),r.removeAttribute("class")):(e(n.responseText),r.removeAttribute("class")))},n.send(null)},i.close=function(){a.innerHTML="",o.setAttribute("style",""),o.style.cssText="",o.style.visibility="hidden",r.setAttribute("style",""),r.style.cssText="",r.style.display="none",s.style.cursor="default",l.setAttribute("style",""),l.style.cssText="",e&&window.clearTimeout(e),n.closeCallback&&n.closeCallback(),window.removeEventListener?window.removeEventListener("resize",t,!1):window.detachEvent&&window.detachEvent("onresize",t)},i.center=function(t){var e=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight),i=Math.max(r.clientWidth,r.offsetWidth),n=Math.max(r.clientHeight,r.offsetHeight),s=0,a=0,l=0,c=0;"number"==typeof window.innerWidth?(s=window.innerWidth,a=window.innerHeight):document.documentElement&&document.documentElement.clientWidth&&(s=document.documentElement.clientWidth,a=document.documentElement.clientHeight),"number"==typeof window.pageYOffset?(c=window.pageYOffset,l=window.pageXOffset):document.body&&document.body.scrollLeft?(c=document.body.scrollTop,l=document.body.scrollLeft):document.documentElement&&document.documentElement.scrollLeft&&(c=document.documentElement.scrollTop,l=document.documentElement.scrollLeft),t.horizontalOnly||(r.style.top=c+a/2-n/2+"px"),r.style.left=l+s/2-i/2+"px",o.style.height=e+"px",o.style.width="100%"},o.setAttribute("id","alloka-modal-overlay"),r.setAttribute("id","alloka-modal-container"),s.setAttribute("id","alloka-modal-header"),a.setAttribute("id","alloka-modal-content"),l.setAttribute("id","alloka-modal-close"),s.appendChild(l),r.appendChild(s),r.appendChild(a),o.style.visibility="hidden",r.style.display="none",window.addEventListener?window.addEventListener("load",function(){document.body.appendChild(o),document.body.appendChild(r)},!1):window.attachEvent&&window.attachEvent("onload",function(){document.body.appendChild(o),document.body.appendChild(r)}),i}();